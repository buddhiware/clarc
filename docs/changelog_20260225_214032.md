# clarc — Sync Cache Invalidation, Tool-Results-Only Session Support & CLAUDE.md

**Date**: 2026-02-25

## Overview

Three related improvements: (1) the scanner's in-memory index cache is now automatically invalidated after each sync cycle; (2) sessions with only `tool-results/*.txt` files (no root `.jsonl`) are now synced, indexed, and rendered in the UI; (3) added `CLAUDE.md` for repository guidance.

## Changes

### Fixed: Sync now invalidates scanner cache automatically

Added `invalidateCache()` export to `scanner.ts`. The sync scheduler calls it after every `runSync()` (both initial and periodic), so the next API request triggers a fresh index scan reflecting newly synced files.

**Before:** New sessions/projects appeared only after `POST /api/sync`, `POST /api/reindex`, or server restart.
**After:** New data appears automatically within one sync cycle (default 5 minutes).

### Fixed: Sync now copies `.txt` files from projects

`DIR_FILTERS.projects` in `sync.ts` previously only allowed `.jsonl` files. Added `.txt` to the filter so Claude Code's externally-cached tool result files (`tool-results/toolu_*.txt`) are synced to the working directory.

### Added: Orphan session directory detection in scanner

After scanning for `.jsonl` session files, the scanner performs a second pass looking for UUID-named subdirectories with no matching `.jsonl`. For each "orphan" directory it creates a synthetic `SessionRef` from `tool-results/*.txt` and `subagents/*.jsonl` contents.

### Added: Tool-results-only session parsing

When `parseSession()` receives a directory path (instead of a `.jsonl` file), it delegates to `parseToolResultSession()` which reads all `.txt` files from `tool-results/`, creates synthetic `Message` objects sorted by modification time, and returns a `Session` with empty token usage metadata.

### Added: UI rendering for tool-result messages

`MessageRenderer` renders `tool-result` type messages as teal-accented cards with the tool use ID as a badge and content as a collapsible preformatted code block. Line-number prefixes (`     1→`) from Claude Code's tool-result cache are stripped before display. Each tool-result gets its own numbered turn via `groupIntoTurns`.

### Added: Error boundary for SessionDetail

Wrapped `SessionDetail` in a React error boundary so rendering crashes display a visible error message instead of a silent blank page.

### Added: CLAUDE.md

Created `CLAUDE.md` at project root with guidance for Claude Code sessions: build/dev commands, architecture overview, data flow, path aliases, env vars, Tauri sidecar pattern, and coding conventions.

### Updated: Documentation

- **DEV_GUIDE.md**: Updated sync allowlist to mention `.txt` files, documented cache invalidation after sync, added orphan session detection to scanner docs, noted tool-results parsing in parser docs.

---

## File Change Summary

### New Files (2)

| File | Description |
|------|-------------|
| `CLAUDE.md` | Claude Code guidance file for repository |
| `docs/changelog_20260225_214032.md` | This changelog |

### Modified Files (8)

| File | Changes |
|------|---------|
| `src/data/scanner.ts` | Added `invalidateCache()` export, `UUID_RE` constant, orphan session detection loop, `scanOrphanSessionRef()` function |
| `src/data/sync-scheduler.ts` | Import `invalidateCache`, call after each `runSync()` |
| `src/data/sync.ts` | Extended `DIR_FILTERS.projects` to include `.txt` files |
| `src/data/parser.ts` | Added directory detection in `parseSession()`, `parseToolResultSession()` function |
| `src/ui/components/MessageRenderer.tsx` | Added `tool-result` rendering as preformatted code; strips line-number prefixes |
| `src/ui/components/ConversationTurn.tsx` | Updated `groupIntoTurns()` to treat each `tool-result` as its own turn |
| `src/ui/pages/SessionDetail.tsx` | Wrapped in `SessionErrorBoundary` |
| `docs/DEV_GUIDE.md` | Updated sync, scanner, and parser documentation |
