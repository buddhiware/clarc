# clarc — Tauri v2 Desktop App Integration

**Date**: 2026-02-25

## Overview

Added Tauri v2 desktop app support. clarc can now be built as a native desktop application with an embedded system webview instead of requiring a browser. The Bun backend runs as a sidecar binary, and the Rust/Tauri shell handles window lifecycle, system tray, and port management.

## Architecture

```
Tauri App Shell (Rust)
├── System WebView (loads React UI)
│   └── fetch('/api/...') → HTTP localhost:PORT
└── Bun Sidecar (clarc-core)
    ├── Hono API server
    ├── Data sync engine
    └── Session parser
```

- **Dev mode**: `bun tauri dev` — native window with Vite HMR (localhost:5173), Hono server runs alongside
- **Production**: Tauri embeds a loading screen, spawns the sidecar binary, waits for readiness signal, then navigates webview to the live server
- **Existing flows unchanged**: Docker dev (`make dev`) and standalone CLI both work as before

## Changes

### New: `src-tauri/` — Tauri project directory

- **`Cargo.toml`**: Rust deps — tauri v2 (with tray-icon), tauri-plugin-shell, tauri-plugin-process, portpicker
- **`tauri.conf.json`**: Window config (1280x800, min 900x600), CSP allowing localhost connections and Google Fonts, sidecar declaration, dev/prod URL configuration
- **`capabilities/default.json`**: Permissions for shell spawning and process management
- **`loading/index.html`**: Animated splash screen with gradient "clarc" logo and spinner, shown while sidecar starts
- **`src/lib.rs`**: Core Rust logic:
  - Finds a free TCP port via `portpicker`
  - Spawns `clarc-core` sidecar with `--port` and `CLARC_APP_DATA` env var
  - Watches stdout for `__CLARC_READY__` signal
  - Navigates webview to `http://localhost:PORT` on readiness
  - Gracefully handles missing sidecar (dev mode)
  - System tray with Show/Quit menu items
  - Kills sidecar on window close or quit
- **`src/main.rs`**: Entry point, delegates to lib.rs
- **`build.rs`**: Standard Tauri build script
- **`binaries/.gitkeep`**: Placeholder for platform-specific sidecar binaries

### New: `.github/workflows/release.yml` — Cross-platform CI

GitHub Actions workflow triggered on version tags (`v*`). Builds for 4 targets:
- `x86_64-unknown-linux-gnu` (Linux x64)
- `aarch64-apple-darwin` (macOS Apple Silicon)
- `x86_64-apple-darwin` (macOS Intel)
- `x86_64-pc-windows-msvc` (Windows x64)

Each job installs Rust + Bun, builds the sidecar binary with platform suffix, then runs `tauri-apps/tauri-action` to produce and publish installers as draft GitHub Releases.

### New: `docs/TAURI_PLAN.md` — Architecture plan artifact

Full design document covering architecture, all phases, file changes, and verification steps.

### Modified: `src/cli/main.ts` — `--port` flag for sidecar mode

Parses `--port <N>` from argv before Commander runs, sets `CLARC_PORT` env var. Strips the flag so Commander doesn't error on unknown args.

### Modified: `src/server/index.ts` — Readiness signal

Prints `__CLARC_READY__ http://localhost:PORT` after the server starts listening. Tauri's Rust code watches stdout for this line to know when to navigate the webview.

### Modified: `src/shared/paths.ts` — Tauri app data support

`getDefaultDataDir()` now checks `CLARC_APP_DATA` env var first (set by Tauri Rust code to platform-standard app data dir). Also recognizes `clarc-core` exec name for sidecar binary detection.

### Modified: `src/shared/config.ts` — Tauri config path support

`getConfigFilePath()` uses `CLARC_APP_DATA` for config file location when running as Tauri sidecar. Also recognizes `clarc-core` exec name.

### Modified: `package.json` — Tauri scripts and dependencies

New scripts: `dev:client`, `dev:tauri`, `build:core`, `build:tauri`, `tauri`. New devDependencies: `@tauri-apps/cli`, `@tauri-apps/api`, `@tauri-apps/plugin-shell`, `@tauri-apps/plugin-process`.

### Modified: `Makefile` — Tauri targets

New targets: `tauri-dev` (dev with native window), `tauri-build` (production build), `tauri-icons` (generate app icons).

### Modified: `.gitignore` — Tauri build artifacts

Added `src-tauri/target/` (Rust build output) and `src-tauri/binaries/clarc-core*` (compiled sidecar binaries).

---

## File Change Summary

### New Files (10)

| File | Description |
|------|-------------|
| `docs/TAURI_PLAN.md` | Architecture plan and design document |
| `src-tauri/Cargo.toml` | Rust dependencies |
| `src-tauri/build.rs` | Tauri build script |
| `src-tauri/tauri.conf.json` | App config, window, CSP, sidecar, plugins |
| `src-tauri/capabilities/default.json` | Shell and process permissions |
| `src-tauri/loading/index.html` | Animated splash screen |
| `src-tauri/src/lib.rs` | Sidecar spawning, port management, system tray |
| `src-tauri/src/main.rs` | Rust entry point |
| `src-tauri/binaries/.gitkeep` | Sidecar binary directory placeholder |
| `.github/workflows/release.yml` | Cross-platform CI release workflow |

### Modified Files (7)

| File | Changes |
|------|---------|
| `src/cli/main.ts` | `--port` flag parsing for sidecar mode |
| `src/server/index.ts` | `__CLARC_READY__` readiness signal |
| `src/shared/paths.ts` | `CLARC_APP_DATA` env var + `clarc-core` exec name |
| `src/shared/config.ts` | `CLARC_APP_DATA` env var + `clarc-core` exec name |
| `package.json` | Tauri scripts and devDependencies |
| `Makefile` | `tauri-dev`, `tauri-build`, `tauri-icons` targets |
| `.gitignore` | `src-tauri/target/`, `src-tauri/binaries/clarc-core*` |
