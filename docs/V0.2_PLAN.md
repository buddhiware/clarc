# clarc v0.2 — Data Sync, Visual Overhaul & UX Redesign

## Context

clarc v0.1 (initial build) is complete and committed. The app works: it reads `~/.claude/`, discovers sessions, and presents them in a browsable web UI. However, the user identified three major areas for improvement:

1. **Data sync model**: Instead of reading `~/.claude` live, create a snapshot/sync architecture (add-only, never removes)
2. **Visual overhaul**: UI is "extremely boring" — needs modern styling, micro-animations, visual depth
3. **Presentation/UX**: Dead agent links, unintuitive timeline, needs artifact-style side panel viewers

No new npm dependencies needed — recharts (already installed) replaces CSS bar charts, all animations are pure CSS.

---

## Phase 1: Data Sync/Snapshot Architecture

### Concept

Introduce a transparent sync layer between `~/.claude/` (read-only source) and `~/.config/clarc/data/` (local working copy). The existing scanner/parser modules read from the local copy instead of the source. Sync is add-only (never deletes), triggered at startup + every 5 minutes + on-demand.

### Data Flow

```
~/.claude/ (SOURCE, read-only)
     |
     v
sync.ts ── copies files ──> ~/.config/clarc/data/
     |                              |
     v                              v
sync-state.json           scanner.ts / parser.ts / stats.ts
                            (read from local copy)
```

### New Files (3)

| File | Purpose | ~Lines |
|------|---------|--------|
| `src/data/sync.ts` | Core sync engine: walk source, diff by mtime+size, copy changed files, manage `sync-state.json` | ~250 |
| `src/data/sync-scheduler.ts` | `initSync()` at startup, `startPeriodicSync()` every 5min | ~60 |
| `src/server/routes/sync.ts` | `GET /api/sync/status`, `POST /api/sync` (trigger sync + reindex) | ~30 |

### Modified Files (4)

**`src/shared/paths.ts`** — The pivot point. Rename `CLAUDE_DIR` → `SOURCE_DIR`, add `DATA_DIR = CONFIG_DIR/data`, redirect `PROJECTS_DIR`/`TODOS_DIR`/`STATS_FILE`/`HISTORY_FILE` to point at local copy. Scanner/parser/stats unchanged because they import these constants.

```
SOURCE_DIR = env CLARC_CLAUDE_DIR || ~/.claude     (read-only source)
DATA_DIR   = CONFIG_DIR/data                        (local working copy)
PROJECTS_DIR = DATA_DIR/projects                    (was SOURCE_DIR/projects)
TODOS_DIR    = DATA_DIR/todos                       (was SOURCE_DIR/todos)
```

**`src/server/index.ts`** — Import `initSync`/`startPeriodicSync`, call before server starts. Mount `/api/sync` route.

**`src/server/routes/system.ts`** — Add sync info to `GET /api/status`. `POST /api/reindex` now syncs first by default (`?sync=false` to skip).

**`src/cli/index.ts`** — Add Commander `preAction` hook calling `initSync()` before CLI commands.

### Sync State (`~/.config/clarc/sync-state.json`)

Tracks `fileInventory` (relative path → {mtime, size, syncedAt}), `lastSyncAt`, `syncCount`, `errors[]`. Detection: compare source file `stat()` mtime+size against inventory entry.

### Key Behaviors
- Initial sync: copies all eligible `.jsonl` and `.json` files from `projects/`, `todos/`, plus `stats-cache.json` and `history.jsonl`
- Incremental: `stat()` comparison only, copy on mtime/size change
- Never deletes from local copy — historical sessions preserved even if source prunes them
- Concurrent sync protection via `isSyncing` boolean flag
- Docker: already has correct mounts (source `:ro`, config writable)

### Unchanged Files
`scanner.ts`, `parser.ts`, `stats.ts`, `tasks.ts` — all read from the same path constants, which now point to local copy. Zero code changes needed in the read pipeline.

---

## Phase 2: Visual Design System Foundation

### `index.html` — Add Google Fonts

```html
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
```

### `src/ui/styles/globals.css` — Full Overhaul

**Expanded CSS custom properties (~50 tokens):**
- Surface layers: `--color-surface-3`, `--color-surface-glass`, `--color-surface-elevated`
- Accent colors: amber, emerald, rose, cyan, violet
- Gradients: `--gradient-primary` (indigo→violet), `--gradient-hero` (indigo→cyan→violet), `--gradient-card-hover`, `--gradient-stat-1` through `--gradient-stat-4`, `--gradient-shimmer`
- Shadows: `--shadow-sm/md/lg/xl`, `--shadow-glow`, `--shadow-glow-hover`, `--shadow-inset`
- Animation tokens: `--ease-out-expo`, `--ease-out-back`, `--duration-fast/base/slow/enter`
- Border radius: `--radius-sm/md/lg/xl`
- Backdrop blur: `--blur-sm/md/lg`

**Keyframe animations (15):**
`fadeIn`, `fadeInUp`, `fadeInDown`, `slideInLeft`, `slideInRight`, `scaleIn`, `shimmer`, `pulse-subtle`, `expand-height`, `collapse-height`, `spin`, `float`, `gradient-shift`, `backdrop-enter`, `count-up`

**Utility classes:**
- `.animate-fadeIn`, `.animate-fadeInUp`, `.animate-scaleIn`, etc.
- `.stagger-children` — nth-child delays up to 8 items (50ms increments)
- `.glass` — backdrop-filter blur + transparent border
- `.skeleton` — shimmer loading placeholder
- `.card` / `.card-glow` — standard card with hover lift + shadow + gradient overlay
- `.btn-primary` / `.btn-ghost` — button styles with transitions
- `.text-gradient` — animated gradient text for hero headings
- `.collapsible-enter` — expand animation for toggle content

**Typography:** Inter for UI, JetBrains Mono for code. Antialiased, tighter letter-spacing.

**Dark mode:** All new tokens get dark-mode overrides with appropriate values.

### New Shared Components (8 files)

| File | Purpose |
|------|---------|
| `src/ui/components/Skeleton.tsx` | Shimmer loading placeholders: variants for text, title, card, stat, chart, circle |
| `src/ui/components/PageTransition.tsx` | Wraps page content with `animate-fadeInUp`, keyed by route path |
| `src/ui/components/StatCard.tsx` | Shared stat card (Dashboard + Analytics): gradient top border, icon, animated value, optional trend indicator |
| `src/ui/components/ChartCard.tsx` | Recharts wrapper: card with title/subtitle and `ResponsiveContainer` |
| `src/ui/components/EmptyState.tsx` | Empty state with icon, title, description (for Tasks, Search no results, etc.) |
| `src/ui/components/Badge.tsx` | Standardized pill badge for model names, git branches, status indicators |
| `src/ui/components/Icons.tsx` | ~15 inline SVG icons (folder, chat, message, dollar, terminal, eye, pencil, etc.) — no icon library |
| `src/ui/components/Tooltip.tsx` | Pure CSS tooltip replacing browser `title=""` attributes |

---

## Phase 3: UX Infrastructure — Context Panel

### Concept

An artifact-style side panel that slides out from the right to show agent conversations, tool call details, file contents, and session previews — without navigating away from the current page. This is the key fix for dead agent links and unintuitive data access.

### New Files (2)

**`src/ui/components/ContextPanelProvider.tsx`** — React context + useReducer managing panel state:
```typescript
interface PanelContent {
  type: 'agent' | 'session-preview' | 'tool-detail' | 'file-content';
  projectId?: string;
  agentId?: string;
  sessionId?: string;
  toolCall?: ToolCall;
  filePath?: string;
  fileContent?: string;
}
// Provides: { isOpen, content, openPanel, closePanel }
// Includes history[] for back-navigation within panel
```

**`src/ui/components/ContextPanel.tsx`** — The panel itself:
- Width: 480px desktop, full-width overlay on mobile
- Slide-in from right: CSS `transform: translateX(100%)` → `translateX(0)`, 300ms ease
- **Pushes** main content narrower on desktop (not overlay)
- Header: title, close button, back breadcrumb if history exists
- Body: scrollable, renders content based on `PanelContent.type`
- Footer: "Open full view" link navigating to the relevant page
- Content types:
  - `agent`: fetches `GET /api/sessions/agents/:projectId/:agentId`, renders with MessageRenderer
  - `session-preview`: fetches `GET /api/sessions/:id/messages?limit=10`, shows preview
  - `tool-detail`: receives ToolCall inline, renders expanded input/output
  - `file-content`: shows file content from tool result with syntax highlighting
- Skeleton loading while fetching

### Modified: `src/ui/components/Layout.tsx`

- Wrap app with `<ContextPanelProvider>`
- Add `<ContextPanel />` as sibling to `<main>`
- When panel open: main gets `marginRight: 480px` transition
- Sidebar: always render `<aside>`, use CSS transform for show/hide animation instead of conditional render (`{sidebarOpen && ...}` → always rendered, `transform: translateX(-100%)` when hidden)
- Wrap `<Outlet />` in `<PageTransition />`
- Escape key closes panel (extend useKeyboardShortcuts)

---

## Phase 4: Component Visual Upgrades

### `src/ui/components/Sidebar.tsx`
- Logo: apply `.text-gradient` class to "clarc" text
- Filter input: focus glow ring (`box-shadow: 0 0 0 2px rgba(99,102,241,0.3)`), inset shadow
- Nav links: add SVG icons (grid, bar-chart, search, check-square), active state with left accent bar (3px `--color-primary`), `font-weight: 500`
- Project items: hover background transition, right chevron that fades in on hover

### `src/ui/components/ThinkingBlock.tsx`
- Smooth expand/collapse: always render content, use `max-height`/`opacity` transition instead of conditional render
- SVG chevron rotating 90° instead of Unicode triangles
- Gradient left border (2px `--gradient-primary`)
- Token estimate: pill badge with `--color-accent-violet`

### `src/ui/components/ToolCallBlock.tsx`
- Same expand/collapse animation as ThinkingBlock
- Small icon per tool type (terminal for Bash, eye for Read, pencil for Edit, etc.)
- Error state: pulsing red dot via `animation: pulse-subtle 2s infinite`
- New prop `onExpand?: () => void` — "open in panel" icon button in header (visible on hover)

### `src/ui/components/MessageRenderer.tsx`
- User messages: avatar circle with "U" + gradient background, bubble-style card with shadow and rounded corners, subtle left border
- Assistant messages: avatar circle with sparkle icon, muted surface background, cost badge color-coded (green < $0.01, amber < $0.10, rose > $0.10)
- New prop `onToolClick?: (toolCall: ToolCall) => void` — wires tool calls to context panel
- File paths in tool calls become clickable links (opens file-content in panel)
- Staggered fade-in animation on message items
- Replace `divide-y` separator with `space-y-3` card spacing

### `src/ui/components/CodeBlock.tsx`
- macOS-style colored dots (red/yellow/green) in header bar
- Copy button: slide-in from right, checkmark animation on success
- Outer border + shadow

### `src/ui/components/KeyboardShortcuts.tsx`
- Backdrop: `backdrop-filter: blur` + `animation: backdrop-enter`
- Modal: `animation: scaleIn` with `--ease-out-back` (slight overshoot)
- Kbd elements: physical key styling with shadow + subtle gradient

---

## Phase 5: Page-Level Redesigns

### `src/ui/pages/Dashboard.tsx`
- **Loading**: Skeleton layout (stat cards, chart, project cards) instead of "Loading..." text
- **Hero**: Gradient background blob (blurred circle, 7% opacity), `.text-gradient` title
- **Stat cards**: Shared `StatCard` with gradient top borders, icons, stagger animation
- **Activity chart**: Replace CSS div bars with recharts `AreaChart` (gradient fill, smooth curve, styled tooltip)
- **Model usage table**: hover row highlighting, primary-colored cost column
- **Project cards**: `.card .card-glow` classes, stagger animation, folder icon

### `src/ui/pages/ProjectDetail.tsx`
- **Loading**: Skeleton layout
- **Header**: Gradient background blob, path as code pill with copy button, stat pill badges
- **Timeline**: Replace flat `space-y-3` with new `SessionTimeline` component (see below)
- **Agents**: Change from dead `<div>` to `<button onClick={() => openPanel({ type: 'agent', ... })}>` — this fixes the dead-link bug

### New: `src/ui/components/SessionTimeline.tsx`
- Vertical line (2px `--color-border`) running down left side, 24px from edge
- Session nodes: circle dots on the rail (filled `--color-primary` for recent, `--color-border` for older)
- Date group headers: "Today", "Yesterday", "This Week", "January 2026" etc.
- Sub-agents: smaller branching nodes connected by dashed horizontal line from rail
- Session cards: `.card .card-glow`, hover shows quick-preview eye icon
- Quick-preview icon opens session in context panel instead of navigating
- `stagger-children` on card entries

### `src/ui/pages/SessionDetail.tsx`
- **Remove dead `showRaw` state** (unused variable)
- **Loading**: Skeleton (header + message placeholders)
- **Sticky header**: Apply `.glass` class for frosted glass effect, `--shadow-md`
- **Breadcrumb**: Chevron separator instead of `/`, session date, copy session ID button
- **Metadata pills**: `Badge` components with color coding
- **Agent chips**: Change `<span>` → `<button onClick={() => openPanel({ type: 'agent', ... })}>` — makes them interactive
- **Message list**: Group into conversation turns (user message + subsequent assistant/tool messages)
- **Buttons**: `.btn-ghost` and `.btn-primary` classes
- **Add**: `<ScrollProgress />` (thin progress bar at top), `<ScrollNav />` (floating jump-to-top/bottom pill)

### New: `src/ui/components/ConversationTurn.tsx`
- Groups one user message + all subsequent assistant messages until next user message
- Shared left border accent (3px `--color-primary` at 20% opacity)
- Turn number displayed small in margin

### New: `src/ui/components/ScrollProgress.tsx`
- Fixed 3px bar at top of viewport, width = scroll percentage, colored `--color-primary`

### New: `src/ui/components/ScrollNav.tsx`
- Floating pill bottom-right with up/down arrows
- Appears after scrolling past first screen, fades in/out

### `src/ui/pages/Analytics.tsx`
- **Loading**: Full skeleton with chart placeholders
- **Stat cards**: Shared `StatCard` with gradients
- **Cost by Model**: Replace CSS bars with recharts horizontal `BarChart`
- **Cache Efficiency**: SVG circular progress indicator for cache hit rate (fills in on mount)
- **Activity by Hour**: Replace CSS bars with recharts `BarChart`
- **NEW — Cost Over Time**: recharts `AreaChart` using `costByDay` data (currently available but not displayed)
- **NEW — Token Usage Over Time**: stacked `AreaChart` with input/output using `tokensByDay` data
- **NEW — Activity Heatmap**: GitHub-style grid (7 rows x 24 cols) using `activityHeatmap` data (CSS grid, no library)
- **Daily Activity Table**: Sticky header, hover row highlighting, alternating rows
- **Top Projects**: Horizontal bars showing relative session counts

### `src/ui/pages/Search.tsx`
- Search input: larger, search icon inside, `.glass` container, focus glow
- Button: `.btn-primary` with gradient
- Loading: Skeleton result cards
- Empty state: `EmptyState` component
- Result cards: `.card .card-glow`, stagger animation, highlight match brighter

### `src/ui/pages/Tasks.tsx`
- Empty state: `EmptyState` component
- Column headers: colored top border (3px solid, matching status color)
- Task cards: `.card` class, left color indicator, hover lift
- Blocked indicator: pulsing red dot

### `src/ui/pages/MarkdownPreview.tsx`
- Toolbar: `.glass` class, sticky, checkboxes as toggle switches
- Buttons: `.btn-ghost`
- Copy: checkmark animation on success

---

## Phase 6: Keyboard & Polish

### `src/ui/hooks/useKeyboard.ts`
- `Escape`: also closes context panel (priority over help overlay)
- `[` / `]`: navigate between sessions within a project (on SessionDetail)

---

## Implementation Order

Execute in this order to maximize incremental testability:

1. **Phase 1**: Data sync (paths.ts, sync.ts, sync-scheduler.ts, sync route, server startup)
2. **Phase 2**: Design system foundation (globals.css, index.html fonts, shared components)
3. **Phase 3**: Context panel infrastructure (provider, panel, Layout changes)
4. **Phase 4**: Component visual upgrades (Sidebar, ThinkingBlock, ToolCallBlock, MessageRenderer, CodeBlock, KeyboardShortcuts)
5. **Phase 5**: Page redesigns (Dashboard, ProjectDetail + SessionTimeline, SessionDetail + ConversationTurn + ScrollProgress + ScrollNav, Analytics with recharts, Search, Tasks, MarkdownPreview)
6. **Phase 6**: Keyboard polish

---

## File Change Summary

### New Files (17)
| File | Category |
|------|----------|
| `src/data/sync.ts` | Data sync |
| `src/data/sync-scheduler.ts` | Data sync |
| `src/server/routes/sync.ts` | Data sync API |
| `src/ui/components/Skeleton.tsx` | Visual |
| `src/ui/components/PageTransition.tsx` | Visual |
| `src/ui/components/StatCard.tsx` | Visual |
| `src/ui/components/ChartCard.tsx` | Visual |
| `src/ui/components/EmptyState.tsx` | Visual |
| `src/ui/components/Badge.tsx` | Visual |
| `src/ui/components/Icons.tsx` | Visual |
| `src/ui/components/Tooltip.tsx` | Visual |
| `src/ui/components/ContextPanelProvider.tsx` | UX |
| `src/ui/components/ContextPanel.tsx` | UX |
| `src/ui/components/SessionTimeline.tsx` | UX |
| `src/ui/components/ConversationTurn.tsx` | UX |
| `src/ui/components/ScrollProgress.tsx` | UX |
| `src/ui/components/ScrollNav.tsx` | UX |

### Modified Files (21)
| File | Changes |
|------|---------|
| `src/shared/paths.ts` | Redirect paths to local data copy |
| `src/shared/types.ts` | Add SyncState, SyncedFile, SyncStatus types |
| `src/server/index.ts` | Mount sync route, init sync at startup |
| `src/server/routes/system.ts` | Sync info in status, sync before reindex |
| `src/cli/index.ts` | preAction sync hook |
| `index.html` | Google Fonts links |
| `src/ui/styles/globals.css` | Full overhaul: tokens, keyframes, utilities |
| `src/ui/components/Layout.tsx` | Context panel, sidebar animation, page transitions |
| `src/ui/components/Sidebar.tsx` | Icons, hover effects, active states, logo |
| `src/ui/components/ThinkingBlock.tsx` | Smooth animation, chevron, gradient border |
| `src/ui/components/ToolCallBlock.tsx` | Animation, icons, onExpand prop |
| `src/ui/components/MessageRenderer.tsx` | Bubbles, avatars, onToolClick prop |
| `src/ui/components/CodeBlock.tsx` | Terminal dots, copy animation |
| `src/ui/components/KeyboardShortcuts.tsx` | Backdrop blur, scale animation |
| `src/ui/pages/Dashboard.tsx` | Skeleton, hero, recharts, stat cards |
| `src/ui/pages/ProjectDetail.tsx` | Timeline, clickable agents |
| `src/ui/pages/SessionDetail.tsx` | Glass header, turns, scroll nav, remove dead state |
| `src/ui/pages/Analytics.tsx` | Full recharts, heatmap, new charts |
| `src/ui/pages/Search.tsx` | Enhanced search bar, result cards |
| `src/ui/pages/Tasks.tsx` | Kanban polish, empty state |
| `src/ui/pages/MarkdownPreview.tsx` | Glass toolbar, toggle switches |
| `src/ui/hooks/useKeyboard.ts` | Panel escape, session navigation |

### Unchanged Files
`scanner.ts`, `parser.ts`, `stats.ts`, `tasks.ts`, `pricing.ts`, all server routes except system.ts, `docker-compose.yml`, `Dockerfile`, `Makefile`, `useApi.ts`

---

## Verification

1. `docker compose up --build` starts without errors
2. `GET /api/sync/status` returns sync state with file count
3. `POST /api/sync` triggers sync, returns updated counts
4. Dashboard loads with skeleton, then animated stats, recharts area chart, gradient hero
5. Navigate to project: see visual timeline with date grouping
6. Click an agent on project page: side panel slides open showing agent conversation
7. Open session: glass header, conversation turns, scroll progress bar
8. Click agent chip in session header: side panel opens
9. Click "open in panel" on tool call: expanded view in panel
10. Analytics: real recharts (bar, area, heatmap), circular cache indicator
11. Search: glass search bar, skeleton loading, staggered result cards
12. Dark mode: all gradients, shadows, glass effects adapt correctly
13. Keyboard: `/` = search, `?` = help, `Esc` = close panel/help
