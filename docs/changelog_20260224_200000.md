# clarc — Collapsible Long Blocks + Settings Page

**Date**: 2026-02-24

## Change 1: Collapsible Long Blocks

Long assistant and user messages now auto-collapse when they exceed a configurable height threshold (default 300px). This keeps conversations scannable without losing content.

- New `CollapsibleContent` component wraps text content in `MessageRenderer`
- Measures content height via ref + `requestAnimationFrame`, compares against threshold
- Collapsed state: `maxHeight` cap, `overflow: hidden`, gradient fade-out overlay, "Show more (N lines)" button
- Expanded state: smooth `maxHeight` transition, "Show less" button at bottom
- **Sticky "Show less" pill**: When expanded and scrolled past the block start, a sticky pill appears at `top: 52px` (below the glass header) so you can collapse without scrolling down. Collapsing scrolls back to the block start.
- Gradient color is context-aware: `--color-user-bubble` for user messages, `--color-surface` for assistant messages
- `collapseThreshold` prop threaded through `ConversationTurn` → `MessageRenderer`
- Threshold of 0 disables collapsing entirely
- Thinking blocks and tool calls are unaffected (they have their own collapse)

## Change 2: Settings Page

New `/settings` page accessible from the sidebar, with three sections:

### Display
- **Theme toggle**: System / Light / Dark — segmented control with Sun, Moon, Monitor icons. Applied via `data-theme` attribute on `<html>`
- **Auto-collapse threshold**: Range slider (0–1000px) with live label. Set to 0 to disable
- **Default show thinking**: Toggle switch controlling initial `showThinking` state in session/agent views

### Data
- Source directory, data directory, sync interval, server port — read from `GET /api/settings/info`

### About
- Version info and link to Help page

### Implementation
- `useSettings` hook reads/writes `clarc-settings` from localStorage
- Theme applied via `data-theme` attribute; CSS updated with `:root:not([data-theme="light"])` for media query dark mode and `:root[data-theme="dark"]` for forced dark
- `GET /api/settings/info` endpoint added to `system.ts` route
- New icons: `SettingsIcon`, `SunIcon`, `MoonIcon`, `MonitorIcon`
- Sidebar updated with Settings link pinned above Help at the bottom

## Change 3: Documentation Updates

- **Help.tsx** (in-app help): Added "Collapsible Content" and "Settings" sections to ToC and body. Updated Session Detail section to mention collapsible messages and configurable thinking default. Updated sidebar and data privacy descriptions.
- **USER_GUIDE.md**: Added Collapsible Content section, Settings section, updated Dark Mode to "Dark Mode & Theming" with manual toggle info, updated sidebar description, updated Help Page section.
- **DEV_GUIDE.md**: Added `CollapsibleContent` to component table, `useSettings` hook docs, `Settings.tsx` to pages, `/api/settings/info` to API reference, updated routing table, sidebar description, MessageRenderer description, dark mode/theming section, and project structure tree.

---

## File Change Summary

### New Files (3)

| File | Description |
|------|-------------|
| `src/ui/components/CollapsibleContent.tsx` | Generic height-based collapse wrapper with gradient fade and sticky pill |
| `src/ui/hooks/useSettings.ts` | localStorage-backed settings hook (theme, collapse, thinking) |
| `src/ui/pages/Settings.tsx` | Settings page with Display, Data, and About sections |

### Modified Files (11)

| File | Changes |
|------|---------|
| `src/ui/components/MessageRenderer.tsx` | Import CollapsibleContent, add `collapseThreshold` prop, wrap user and assistant text |
| `src/ui/components/ConversationTurn.tsx` | Add and pass through `collapseThreshold` prop |
| `src/ui/components/Icons.tsx` | Add SettingsIcon, SunIcon, MoonIcon, MonitorIcon |
| `src/ui/components/Sidebar.tsx` | Add Settings link pinned above Help at bottom |
| `src/ui/styles/globals.css` | Add `[data-theme="dark"]` block, update media query to exclude `[data-theme="light"]` |
| `src/ui/App.tsx` | Add `/settings` route |
| `src/ui/pages/SessionDetail.tsx` | Read settings for defaultShowThinking and collapseThreshold |
| `src/ui/pages/AgentDetail.tsx` | Read settings for defaultShowThinking and collapseThreshold |
| `src/server/routes/system.ts` | Add `GET /api/settings/info` endpoint |
| `src/ui/pages/Help.tsx` | Add Collapsible Content, Settings sections; update Session Detail, sidebar, data privacy |
| `docs/USER_GUIDE.md` | Add Collapsible Content, Settings sections; update Dark Mode, sidebar, Help Page |
| `docs/DEV_GUIDE.md` | Add CollapsibleContent, useSettings, Settings page, /api/settings/info, update theme docs |
