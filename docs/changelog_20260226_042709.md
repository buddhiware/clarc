# clarc — Multi-Source Directory Support

**Date**: 2026-02-26

## Overview

Added support for syncing from multiple Claude Code source directories into a unified view. This enables merging data from WSL and Windows Claude desktop installations on the same machine, or from multiple machines synced to one location. Includes WSL auto-detection of Windows-side `.claude` directories and a multi-source editor in the Settings UI.

## Changes

### Added: Multi-source sync engine

The sync engine now iterates all configured source directories, flat-merging `projects/` and `todos/` into the same `DATA_DIR`. Project IDs are path-encoded and session UUIDs are globally unique, so no collisions occur. `history.jsonl` from each source is copied to `history-{N}.jsonl` then merged with deduplication by `sessionId:timestamp`. `stats-cache.json` uses last-wins across sources. Inventory keys in `sync-state.json` are prefixed with `{sourceIndex}:` for per-source tracking. Sync state auto-migrates from v1 (single source) to v2 (multi-source).

### Added: `sourceDirs` config field

New `sourceDirs: string[]` field in `clarc.json` alongside the existing `sourceDir: string` (backward compatible). Resolution priority: `CLARC_CLAUDE_DIR` env var (now supports colon-separated paths like `$PATH`) > `config.sourceDirs` > `config.sourceDir` > `[~/.claude]`. Paths are deduplicated. Validation checks each entry for a `projects/` subdirectory.

### Added: WSL auto-detection

New `src/shared/wsl-detect.ts` utility with `isWSL()` (checks `/proc/version` for "microsoft") and `detectWindowsClaudeDirs()` (scans `/mnt/c/Users/*/.claude/` and `/mnt/d/Users/*/.claude/` for valid Claude directories). Exposed via new `GET /api/settings/detect-sources` endpoint.

### Updated: Settings UI — multi-source editor

The source directory field is now a dynamic list with add/remove buttons. Each row is a text input with an X button to remove. An "Add source" button appends rows, and an "Auto-detect" button calls the detect-sources API and shows discovered directories as clickable suggestions. When env-overridden, all source dirs display as read-only code blocks.

### Updated: API routes

- `GET /api/status` and `GET /api/settings/info` now include `sourceDirs: string[]` alongside `sourceDir` (compat)
- `POST /api/settings/config` handles `sourceDirs` field; clears legacy `sourceDir` when `sourceDirs` is set
- New `GET /api/settings/detect-sources` returns detected Windows Claude dirs on WSL

### Updated: Types

- `SyncState` bumped to version 2: `sourceDir` → `sourceDirs`, inventory keys prefixed
- `SyncedFile` gains `sourceIndex: number` field
- `SyncStatus` gains `sourceDirs: string[]` (keeps `sourceDir` for backward compat)

### Added: PlusIcon

New `PlusIcon` SVG component in `Icons.tsx` for the add-source button. Also updated `IconProps` interface to support `style` prop (from previous sync button commit).

---

## File Change Summary

### New Files (3)

| File | Description |
|------|-------------|
| `src/shared/wsl-detect.ts` | WSL detection + Windows Claude dir auto-discovery |
| `docs/changelog_20260226_042709.md` | This changelog |

### Modified Files (9)

| File | Change |
|------|--------|
| `src/shared/config.ts` | Added `sourceDirs?: string[]` to ClarcConfig, multi-path validation |
| `src/shared/paths.ts` | Added `SOURCE_DIRS: string[]` with colon-split env var support, removed `CLAUDE_DIR` alias |
| `src/shared/types.ts` | SyncState v2, SyncedFile.sourceIndex, SyncStatus.sourceDirs |
| `src/data/sync.ts` | Multi-source sync loop, prefixed inventory keys, history merge, v1→v2 migration |
| `src/server/routes/system.ts` | Multi-source API fields, detect-sources endpoint |
| `src/ui/pages/Settings.tsx` | Multi-source directory editor with add/remove + auto-detect |
| `src/ui/components/Icons.tsx` | Added PlusIcon |
| `docs/USER_GUIDE.md` | Updated Data Sync, Settings, Configuration, FAQ sections for multi-source |
| `docs/DEV_GUIDE.md` | Updated config, paths, types, sync engine, API docs for multi-source |
| `CLAUDE.md` | Updated env var table for colon-separated CLARC_CLAUDE_DIR |
