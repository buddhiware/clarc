# clarc — Tauri Build Fixes & CI Workflow

**Date**: 2026-02-25

## Overview

Fixed all issues preventing the Tauri v2 desktop app from compiling: missing icon files, Rust lifetime errors, incorrect shell plugin configuration, and AppImage bundling failure in Docker. Updated the CI release workflow with proper cross-platform support. The Docker-based Tauri build now produces working `.deb` and `.rpm` packages.

## Changes

### Fixed: Missing icon files (`src-tauri/icons/`)

Added placeholder icon files required by `tauri::generate_context!()` at compile time. Generated programmatically as solid indigo (matching clarc's brand color) at the required sizes.

**New files**: `32x32.png`, `128x128.png`, `128x128@2x.png`, `icon.ico`, `icon.icns`

### Fixed: Rust lifetime error in `src-tauri/src/lib.rs`

The `MutexGuard` temporary from `state.lock().unwrap().sidecar_child.take()` outlived the `state` binding in `if let` patterns. Split into separate `guard` bindings so the `MutexGuard` is dropped correctly. Applied in both `on_window_event` (window close) and `build_tray` (quit menu item).

### Fixed: Shell plugin configuration (`tauri.conf.json` + `capabilities/default.json`)

The `plugins.shell` section in `tauri.conf.json` had `sidecar` and `scope` fields that are not valid in Tauri v2 — the runtime error was: `unknown field 'scope', expected 'open'`. Moved sidecar scope to the capabilities file where Tauri v2 expects it, using the scoped permission format:

```json
{
  "identifier": "shell:allow-spawn",
  "allow": [{ "name": "binaries/clarc-core", "sidecar": true, "args": true }]
}
```

### Fixed: AppImage build failure in Docker (`Dockerfile.tauri`)

`linuxdeploy` requires FUSE, which is unavailable in Docker containers. Added `--bundles deb rpm` to the Tauri build command in Dockerfile.tauri to skip AppImage and only produce `.deb` and `.rpm` packages. AppImage can still be built natively on the host or in CI.

### Updated: CI release workflow (`.github/workflows/release.yml`)

- Added `sidecar_suffix` matrix variable — Windows requires `.exe` extension on the sidecar binary name
- Added `bun run build:client` step — frontend must be built before sidecar compilation (sidecar serves the static files)
- Added `swatinem/rust-cache@v2` — caches Rust compilation artifacts to speed up CI (~200+ crates)

### Updated: Documentation

- **USER_GUIDE.md**: Added "Option C: Desktop App (Tauri)" installation section with GitHub Releases, host build, and Docker build instructions
- **DEV_GUIDE.md**: Added Tauri make targets to commands table, `tauri-build` Docker service description, `src-tauri/` to project structure, Tauri build + architecture section under "Building for Production"

---

## File Change Summary

### New Files (6)

| File | Description |
|------|-------------|
| `src-tauri/icons/32x32.png` | 32x32 placeholder icon |
| `src-tauri/icons/128x128.png` | 128x128 placeholder icon |
| `src-tauri/icons/128x128@2x.png` | 256x256 placeholder icon (Retina) |
| `src-tauri/icons/icon.ico` | Windows ICO icon |
| `src-tauri/icons/icon.icns` | macOS ICNS icon |
| `docs/changelog_20260225_020000.md` | This changelog |

### Modified Files (7)

| File | Changes |
|------|---------|
| `src-tauri/src/lib.rs` | Fixed MutexGuard lifetime in window close and tray quit handlers |
| `src-tauri/tauri.conf.json` | Removed invalid `scope`/`sidecar` from `plugins.shell`, replaced with `open: true` |
| `src-tauri/capabilities/default.json` | Added scoped `shell:allow-spawn` permission for clarc-core sidecar |
| `Dockerfile.tauri` | Added `--bundles deb rpm` to skip AppImage in Docker |
| `.github/workflows/release.yml` | Added sidecar_suffix, frontend build step, Rust caching |
| `docs/USER_GUIDE.md` | Added Tauri desktop app installation option |
| `docs/DEV_GUIDE.md` | Added Tauri commands, Docker service, project structure, build docs |
