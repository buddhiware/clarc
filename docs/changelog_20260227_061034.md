# clarc — Fix Tauri Desktop App Sidecar Startup

**Date**: 2026-02-27

## Overview

Fixed the Tauri desktop app failing to connect to the sidecar server. Two root causes: the HTTP server was never actually started in compiled binary mode, and the frontend files were not bundled into the Tauri app package.

## Changes

### Fixed: Server not starting in compiled sidecar mode

Replaced `export default { port, fetch }` with explicit `Bun.serve()` in `src/server/index.ts`. The `export default` pattern only auto-starts an HTTP server for the entry point module, but the server module is dynamically imported from `main.ts` — so in compiled binaries, Bun never started the HTTP server. Using `Bun.serve()` explicitly guarantees the port is bound before the `__CLARC_READY__` signal is emitted.

### Fixed: Frontend files not bundled in Tauri app

Added `dist/` as a Tauri bundled resource via `bundle.resources` in `tauri.conf.json`. The Rust sidecar launcher now passes `CLARC_DIST_DIR` env var pointing to the bundled resource path. The server uses this path (falling back to `./dist` for dev/standalone mode) for static file serving.

### Fixed: Release workflow build failures

- Replaced deprecated `macos-13` runner with `macos-latest` cross-compiling to `x86_64-apple-darwin`
- Added explicit `--target` and `--bundles` flags per platform matrix entry
- Skipped broken AppImage bundler on Linux (deb+rpm only)
- Regenerated `icon.ico` from PNGs (was malformed at 498 bytes, broke Windows RC compiler)

---

## File Change Summary

### Modified Files (5)

| File | Change |
|------|--------|
| `src/server/index.ts` | Replace `export default` with explicit `Bun.serve()`, use `CLARC_DIST_DIR` for static file root |
| `src-tauri/tauri.conf.json` | Add `bundle.resources` for `dist/`, version bump to 1.0.0 |
| `src-tauri/src/lib.rs` | Pass `CLARC_DIST_DIR` env var to sidecar pointing to bundled resource dir |
| `src-tauri/icons/icon.ico` | Regenerated proper multi-size ICO from PNGs (32x32, 128x128, 256x256) |
| `.github/workflows/release.yml` | Fix macos-13 → macos-latest, add per-platform bundle targets, add --target flag |
| `docs/DEV_GUIDE.md` | Updated server startup and Tauri architecture sections |
